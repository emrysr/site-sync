#!/bin/bash
#import settings
source settings.conf

### change this for different syncs ###
SOURCE="DEV"
DESTINATION="TEST"


## these will change for each sync type
DB_SRC_CONF=${SOURCE}_MYSQL_CONF
DB_SRC=${SOURCE}_DB_NAME
DB_DEST_CONF=${DESTINATION}_MYSQL_CONF
DB_DEST=${DESTINATION}_DB_NAME

SSH=${DESTINATION}_SSH

DB_SRC_BACKUP=src_backup.sql.gz
DB_DEST_BACKUP=dest_backup.sql.gz

BASE_DEST=${DESTINATION}_PATH
BASE_SRC=${SOURCE}_PATH

#confirmation warning message
text_red
read -r -p "Are you sure you want to overwrite ${!DB_DEST} ? [y/N] ..." response
response=${response,,}    # tolower
if [[ "$response" =~ ^(yes|y)$ ]]
then
#warning ok
  text_reset
  printVariables
  exit
#backup destination database
  #printf "${ColourOff}\n"
  echo "Backing up ${DESTINATION} database..."
  if [ "$DEBUG" = true ] ; then
    echo "no db sync-DEV MODE"
  else
    mysqldump --defaults-file=${!DB_DEST_CONF} ${!DB_DEST} | gzip | pv --size $SIZE_COMPRESSED > $DB_DEST_BACKUP
    echo Backup done
  fi

#backup source database
  #separator
  printf "${Green}Backing up ${SOURCE} database...${ColourOff}\n"
  if [ "$DEBUG" = true ] ; then
    echo "no db sync-DEV MODE"
  else
    mysqldump --defaults-file=${!DB_SRC_CONF} ${!DB_SRC}  |  gzip | pv --size $SIZE_COMPRESSED > $DB_SRC_BACKUP
    echo Backup done
  fi
#import source db into destination db
  #separator
  printf "${Green}Importing ${SOURCE} mysqldump...${ColourOff}\n"
  if [ "$DEBUG" = true ] ; then
    echo "no db sync-DEV MODE"
  else
    zcat $DB_SRC_BACKUP | pv --size $SIZE | mysql --defaults-file=${!DB_DEST_CONF} ${!DB_DEST}
    echo Import done
  fi
 #loop through all the directories set in include file
  separator
  printf "${Green}Syncing files changed in ${SOURCE} to ${DESTINATION}"
  printf "${Yellow} ${i}...${ColourOff}\n"
  if [ "$DEBUG" = true ] ; then
    echo "no sync - DEV MODE"
  else
    rsync -az --info=progress2 --recursive --exclude-from=${EXCLUDES} --files-from=${INCLUDES} ${!BASE_SRC}/ ${!SSH}:${!BASE_DEST}/
    echo Files transfered
  fi

#done message
  printf "${Yellow}\n  DONE :)   "
  printf "${ColourOff}${DESTINATION} synced with ${SOURCE}\n\n"
  if [ "$DEBUG" = true ] ; then
    echo "END DEGUG"
  fi
else
#warning cancelled
echo ABORTED!
fi

